<?php
/*
 * Implementation of hook_imagecache_default_presets
 */
function wysiwyg_imageupload_browser_imagecache_default_presets() {
  $presets = array();
  $presets['wysiwyg_imageupload_browser'] = array (
    'presetname' => 'wysiwyg_imageupload_browser',
    'actions' => array (
      0 => array (
        'weight' => '0',
        'module' => 'imagecache',
        'action' => 'imagecache_scale_and_crop',
        'data' => array (
          'width' => '200',
          'height' => '200',
          'upscale' => 0,
        ),
    ),
  ));
  return $presets;
}
/*
 * Implementation of hook_menu
 */
function wysiwyg_imageupload_browser_menu() {
  $items = array();
  $items['ajax/wysiwyg_imageupload_browser/%'] = array(
    'page callback' => 'wysiwyg_imageupload_browser_browser',
    'page arguments' => array(2),
    'access callback' => 'user_access',
    'access arguments' => array('use wysiyg image upload'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}
/*
 * Implementation of hook_form_alter
 */
function wysiwyg_imageupload_browser_form_alter(&$form, $form_state, $form_id){
  if ($form_id == 'wysiwyg_imageupload_upload_form') {
    $tabs = array();
    $tabs[] = '<a href="#">New Image</a>';
    $tabs[] = l(t('Browser'), 'ajax/wysiwyg_imageupload_browser/'.$form["#parameters"][2], array('title' => t('Choose a new image out of all your already uploaded ones')));
    $form['browse'] = array(
      '#value' => wysiwyg_imageupload_browser_tabs($tabs,1),
      '#weight' => 0,
    );
  }
  if ($form_id == 'wysiwyg_imageupload_admin_settings') {
    $form['wysiwyg_imageupload_browser_itemcount'] = array(
      '#type' => 'textfield',
      '#title' => t('Max. Items Displayed'),
      '#description' => t('Define how many Images should be displayed inside the Browser'),
      '#default_value' => variable_get('wysiwyg_imageupload_browser_itemcount', ''),
      '#weight' => 0,
    );
  }
}
/*
 * Generate the Browser
 */
function wysiwyg_imageupload_browser_browser($form_id){
  jquery_ui_dialog_child_js();
  module_invoke('admin_menu', 'suppress');
  global $user, $base_url;
  $tabs = array();
  $tabs[] = l(t('New Image'), 'ajax/wysiwyg_imgupl/add/'.arg(2), array('title' => t('Go back to the upload form and upload a new image')));
  $tabs[] = '<a href="#">Browser</a>';
  $output .= wysiwyg_imageupload_browser_tabs($tabs,2);
  $result = db_query('Select fid, filepath from {files} where uid = %d LIMIT %d',$user->uid, variable_get('wysiwyg_imageupload_browser_itemcount', 6));
  while($row = db_fetch_array($result)){
    $imageHTML = '<div style="float:left; width:200px; height:200px;">';
    $imageHTML .= theme('imagecache', 'wysiwyg_imageupload_browser', $row['filepath'], t('Insert this image'));
    $imageHTML .= '</div>';
    $output .= l($imageHTML, 'ajax/wysiwyg_imgupl/update/Title/', array('title' => t('Insert this image'),'html' => 'true', 'absolute' => TRUE, 'query' => array('imagepath' => $row['filepath'])));
  }
  return $output;
}
function wysiwyg_imageupload_browser_tabs($tabs,$active){
  $m = drupal_get_path('module', 'wysiwyg_imageupload_browser');
  drupal_add_css($m.'/wysiwyg_imageupload_browser.css');
  $i = 1;
  $offset = 10;
  $output .= '<ul style="float:left; height:22px; width:100%; border-bottom:1px solid black;">';
  foreach($tabs as $tab){     
    if($i == $active){$class = 'active';}else{$class = 'inactive';}
    $output .= '<li class="wysiwyg_imageupload_browser_'.$class.'">'.$tab.'</li>';
    $i++;
    $offset += 130;
  }
  $output .= '</ul>';
  return $output;
}